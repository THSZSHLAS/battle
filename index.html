<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±¤è‡£å­¦ä¹ ç›‘ç£ç³»ç»Ÿ</title>
    <style>
        body {
            margin: 0; padding: 0;
            background-color: #1a1a1a;
            height: 100vh;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-family: 'Segoe UI', sans-serif;
            color: white;
            overflow: hidden;
            user-select: none;
        }

        /* === æ ¸å¿ƒè§†è§‰ UIï¼šå‘¼å¸åœ†ç¯ === */
        #visual-ring {
            width: 200px; height: 200px;
            border: 8px solid #333; /* é»˜è®¤ç°è‰² */
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
        }

        /* å­¦ä¹ ä¸­ï¼šç»¿è‰²å‘¼å¸ */
        body.studying #visual-ring {
            border-color: #2ecc71;
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.3);
            animation: breathe 3s infinite ease-in-out;
        }

        /* è­¦å‘Šï¼šçº¢è‰²é—ªçƒ */
        body.warning #visual-ring {
            border-color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.2);
            box-shadow: 0 0 50px rgba(231, 76, 60, 0.6);
            transform: scale(1.1);
        }

        /* çŠ¶æ€æ–‡å­— */
        #status-text {
            margin-top: 40px;
            font-size: 24px;
            font-weight: 300;
            opacity: 0.8;
            letter-spacing: 2px;
        }

        /* éšè—çš„è§†é¢‘æº */
        video { position: absolute; top: 10px; right: 10px; width: 120px; opacity: 0.3; border-radius: 8px; transform: scaleX(-1); }

        /* åº•éƒ¨æ§åˆ¶æ  */
        #controls {
            position: fixed; bottom: 50px;
            display: flex; gap: 20px;
        }

        button {
            padding: 12px 30px;
            border-radius: 30px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        button:active { transform: scale(0.95); }

        #start-btn { background: #2ecc71; color: #fff; }
        #stop-btn { background: #e74c3c; color: #fff; display: none; }

        /* å€’è®¡æ—¶é®ç½© */
        #countdown-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center; justify-content: center; flex-direction: column;
            z-index: 100;
        }
        #cnt-num { font-size: 120px; font-weight: bold; color: #2ecc71; }
        #cnt-tip { font-size: 20px; margin-top: 20px; color: #ccc; }

        /* ç»“ç®—æŠ¥å‘Šé¢æ¿ */
        #report-panel {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; background: #fff; color: #333;
            padding: 30px; border-radius: 20px;
            display: none; flex-direction: column; gap: 15px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 200; text-align: center;
        }
        .stat-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .score-display { font-size: 48px; font-weight: bold; color: #2ecc71; margin: 10px 0; }
        .close-report { background: #333; color: white; margin-top: 10px; }

        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="visual-ring">
        <div style="font-size: 40px;">ğŸ‘ï¸</div>
    </div>
    <div id="status-text">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>

    <video id="webcam" autoplay playsinline muted></video>

    <div id="controls">
        <button id="start-btn" disabled>åŠ è½½æ¨¡å‹ä¸­...</button>
        <button id="stop-btn">åœæ­¢ (éœ€å¯†ç )</button>
    </div>

    <div id="countdown-overlay">
        <div id="cnt-num">3</div>
        <div id="cnt-tip">è¯·ä¿æŒæ ‡å‡†å­¦ä¹ å§¿åŠ¿<br>ç³»ç»Ÿæ­£åœ¨æ ¡å‡†...</div>
    </div>

    <div id="report-panel">
        <h3>æœ¬æ¬¡å­¦ä¹ æŠ¥å‘Š</h3>
        <div class="score-display" id="final-score">98</div>
        <div class="stat-item"><span>â±ï¸ æ—¶é•¿</span><span id="stat-time">0åˆ†</span></div>
        <div class="stat-item"><span>ğŸ‘€ èµ°ç¥</span><span id="stat-distract">0æ¬¡</span></div>
        <div class="stat-item"><span>ğŸ¦´ å§¿æ€</span><span id="stat-posture">0æ¬¡</span></div>
        <div class="stat-item"><span>ğŸ‘» æ¶ˆå¤±</span><span id="stat-absent">0æ¬¡</span></div>
        <button class="close-report" onclick="location.reload()">é‡æ–°å¼€å§‹</button>
    </div>

    <script type="module">
        // å¯¼å…¥æ ¸å¿ƒåº“ (ä½¿ç”¨æ¨¡å—åŒ–å¯¼å…¥è§£å†³ SyntaxError)
        import { FilesetResolver, FaceLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js";

        // ================= é…ç½®åŒº =================
        const CONFIG = {
            // ç®¡ç†å‘˜å¯†ç 
            PASSWORD: "8888", 
            
            // åˆ¤å®šçµæ•åº¦
            threshold: {
                angle: 0.25, 
                dist: 0.15   
            },
            
            checkInterval: 1000 
        };

        const SPEECH = {
            start: "å§¿æ€å·²é”å®šï¼Œç›‘ç£å¼€å§‹ã€‚è¯·ä¿æŒä¸“æ³¨ã€‚",
            distracted: ["çœ‹å“ªå‘¢ï¼Ÿå›æ¥çœ‹ä¹¦ã€‚", "åˆ«ä¸œå¼ è¥¿æœ›ã€‚", "æ³¨æ„åŠ›é›†ä¸­ï¼"],
            posture: ["åå§¿å˜å½¢äº†ï¼Œè°ƒæ•´ä¸€ä¸‹ã€‚", "æ­ªä¸ƒæ‰­å…«çš„ï¼Œåç›´ï¼"],
            absent: ["äººå‘¢ï¼Ÿå¿«å›æ¥ï¼", "ä½ è¦å»å“ªï¼Ÿå­¦ä¹ è¿˜æ²¡ç»“æŸï¼"],
            stop: "ç›‘ç£ç»“æŸã€‚æ¥çœ‹æˆç»©å•ã€‚"
        };

        // ================= æ ¸å¿ƒå˜é‡ =================
        let faceLandmarker = null;
        let isRunning = false;
        let lastVideoTime = -1;
        let lastCheck = 0;
        
        let basePose = { yaw: 0, pitch: 0, roll: 0 };

        let stats = {
            startTime: 0,
            distractCount: 0,
            postureCount: 0,
            absentCount: 0
        };

        // ================= åˆå§‹åŒ– =================
        async function initVision() {
            try {
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
                faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
                        delegate: "GPU"
                    },
                    outputFaceBlendshapes: true,
                    runningMode: "VIDEO",
                    numFaces: 1
                });
                
                // æ¨¡å‹åŠ è½½å®Œæ¯•
                document.getElementById('status-text').innerText = "è®¾å¤‡å°±ç»ª";
                const btn = document.getElementById('start-btn');
                btn.innerText = "å¼€å§‹ç›‘ç£";
                btn.disabled = false;
                
            } catch (error) {
                console.error(error);
                document.getElementById('status-text').innerText = "åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ";
            }
        }
        
        // å¯åŠ¨åˆå§‹åŒ–
        initVision();

        const video = document.getElementById('webcam');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');

        // ================= æµç¨‹æ§åˆ¶ =================
        
        startBtn.onclick = async () => {
            if (!faceLandmarker) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                video.srcObject = stream;
                // ç¡®ä¿è§†é¢‘æµåŠ è½½åå†æ ¡å‡†
                video.onloadeddata = () => {
                    startCalibration();
                };
            } catch(e) {
                alert("æ— æ³•æ‰“å¼€æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿ä½¿ç”¨ HTTPS æˆ– localhost");
            }
        };

        function startCalibration() {
            const overlay = document.getElementById('countdown-overlay');
            const numEl = document.getElementById('cnt-num');
            overlay.style.display = 'flex';
            
            let count = 3;
            numEl.innerText = count;
            speak("è¯·ä¿æŒæ ‡å‡†å­¦ä¹ åå§¿ï¼Œä¸‰ç§’åé”å®šã€‚");

            const timer = setInterval(() => {
                count--;
                numEl.innerText = count;
                if (count <= 0) {
                    clearInterval(timer);
                    overlay.style.display = 'none';
                    captureBasePose();
                }
            }, 1000);
        }

        function captureBasePose() {
            const now = Date.now();
            const results = faceLandmarker.detectForVideo(video, now);
            
            if (results.faceLandmarks.length > 0) {
                const lm = results.faceLandmarks[0];
                basePose = calculatePose(lm);
                
                isRunning = true;
                stats.startTime = Date.now();
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                document.body.className = "studying";
                document.getElementById('status-text').innerText = "ç›‘ç£è¿›è¡Œä¸­...";
                speak(SPEECH.start);
                
                predictLoop();
            } else {
                alert("æœªæ£€æµ‹åˆ°äººè„¸ï¼Œè¯·è°ƒæ•´å…‰çº¿æˆ–ä½ç½®é‡è¯•");
            }
        }

        stopBtn.onclick = () => {
            const pwd = prompt("è¯·è¾“å…¥å¯†ç åœæ­¢ç›‘ç£ï¼š");
            if (pwd === CONFIG.PASSWORD) {
                isRunning = false;
                showReport();
            } else {
                alert("å¯†ç é”™è¯¯ï¼Œè°ä¹Ÿåˆ«æƒ³è·‘ï¼");
                speak("å¯†ç é”™è¯¯ï¼Œç»§ç»­å­¦ä¹ ã€‚");
            }
        };

        async function predictLoop() {
            if (!isRunning) return;
            
            const now = Date.now();
            if (now - lastCheck > CONFIG.checkInterval) {
                if (video.currentTime !== lastVideoTime) {
                    lastVideoTime = video.currentTime;
                    const results = faceLandmarker.detectForVideo(video, now);
                    analyzeBehavior(results);
                    lastCheck = now;
                }
            }
            requestAnimationFrame(predictLoop);
        }

        function analyzeBehavior(results) {
            if (results.faceLandmarks.length === 0) {
                handleWarning("absent", "ğŸ‘» ç›®æ ‡ä¸¢å¤±");
                return;
            }

            const currentPose = calculatePose(results.faceLandmarks[0]);
            
            const diffYaw = Math.abs(currentPose.yaw - basePose.yaw);
            const diffPitch = currentPose.pitch - basePose.pitch;
            const diffRoll = Math.abs(currentPose.roll - basePose.roll);
            
            if (diffYaw > CONFIG.threshold.angle) {
                handleWarning("distracted", "ğŸ‘€ åˆ«ä¸œå¼ è¥¿æœ›");
            } 
            else if (diffPitch < -CONFIG.threshold.angle) {
                handleWarning("distracted", "ğŸ‘† åˆ«æŠ¬å¤´ï¼Œçœ‹ä¹¦");
            }
            else if (diffRoll > 20) {
                handleWarning("posture", "ğŸ¦´ åç›´äº†");
            } 
            else {
                document.body.className = "studying";
                document.getElementById('status-text').innerText = "ä¸“æ³¨ä¸­...";
            }
        }

        function calculatePose(lm) {
            const nose = lm[1];
            const leftEye = lm[33];
            const rightEye = lm[263];
            
            const midX = (leftEye.x + rightEye.x) / 2;
            const yaw = nose.x - midX; 

            const eyeY = (leftEye.y + rightEye.y) / 2;
            const pitch = nose.y - eyeY; 

            const dx = rightEye.x - leftEye.x;
            const dy = rightEye.y - leftEye.y;
            const roll = Math.atan2(dy, dx) * 180 / Math.PI;

            return { yaw, pitch, roll };
        }

        let warnCooldown = 0;
        function handleWarning(type, text) {
            document.body.className = "warning";
            document.getElementById('status-text').innerText = text;
            
            if (Date.now() > warnCooldown) {
                if(type === "distracted") stats.distractCount++;
                if(type === "posture") stats.postureCount++;
                if(type === "absent") stats.absentCount++;
                
                speak(pick(SPEECH[type]));
                warnCooldown = Date.now() + 5000;
            }
        }

        function showReport() {
            const durationMin = Math.floor((Date.now() - stats.startTime) / 60000);
            
            document.getElementById('stat-time').innerText = durationMin + " åˆ†é’Ÿ";
            document.getElementById('stat-distract').innerText = stats.distractCount + " æ¬¡";
            document.getElementById('stat-posture').innerText = stats.postureCount + " æ¬¡";
            document.getElementById('stat-absent').innerText = stats.absentCount + " æ¬¡";
            
            // ç®€å•çš„è¯„åˆ†å…¬å¼
            let score = 100 - (stats.distractCount * 2 + stats.postureCount * 2 + stats.absentCount * 5);
            if (score < 0) score = 0;

            const scoreEl = document.getElementById('final-score');
            scoreEl.innerText = score;
            scoreEl.style.color = score > 80 ? "#2ecc71" : (score > 60 ? "#f1c40f" : "#e74c3c");

            document.getElementById('report-panel').style.display = 'flex';
            speak(SPEECH.stop + `ä½ çš„å¾—åˆ†æ˜¯ ${score} åˆ†ã€‚`);
        }

        const synth = window.speechSynthesis;
        function speak(text) {
            if (!text) return;
            synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = "zh-CN"; u.rate = 1.2;
            synth.speak(u);
        }
        function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        // è§£é” iOS éŸ³é¢‘
        document.body.addEventListener('click', () => {
            if(window.speechSynthesis) synth.speak(new SpeechSynthesisUtterance(" "));
        }, { once: true });

    </script>
</body>
</html>
