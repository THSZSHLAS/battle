<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI å­¦ä¹ ç›‘å·¥ - ä¸“ä¸šç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js" crossorigin="anonymous"></script>
    <style>
        body {
            margin: 0; padding: 0;
            background-color: #1a1a1a;
            height: 100vh;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-family: 'Segoe UI', sans-serif;
            color: white;
            overflow: hidden;
            user-select: none;
        }

        /* === æ ¸å¿ƒè§†è§‰ UIï¼šå‘¼å¸åœ†ç¯ === */
        #visual-ring {
            width: 200px; height: 200px;
            border: 8px solid #333; /* é»˜è®¤ç°è‰² */
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
        }

        /* å­¦ä¹ ä¸­ï¼šç»¿è‰²å‘¼å¸ */
        body.studying #visual-ring {
            border-color: #2ecc71;
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.3);
            animation: breathe 3s infinite ease-in-out;
        }

        /* è­¦å‘Šï¼šçº¢è‰²é—ªçƒ */
        body.warning #visual-ring {
            border-color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.2);
            box-shadow: 0 0 50px rgba(231, 76, 60, 0.6);
            transform: scale(1.1);
        }

        /* çŠ¶æ€æ–‡å­— */
        #status-text {
            margin-top: 40px;
            font-size: 24px;
            font-weight: 300;
            opacity: 0.8;
            letter-spacing: 2px;
        }

        /* éšè—çš„è§†é¢‘æº */
        video { position: absolute; top: 10px; right: 10px; width: 120px; opacity: 0.3; border-radius: 8px; transform: scaleX(-1); }

        /* åº•éƒ¨æ§åˆ¶æ  */
        #controls {
            position: fixed; bottom: 50px;
            display: flex; gap: 20px;
        }

        button {
            padding: 12px 30px;
            border-radius: 30px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        button:active { transform: scale(0.95); }

        #start-btn { background: #2ecc71; color: #fff; }
        #stop-btn { background: #e74c3c; color: #fff; display: none; }

        /* å€’è®¡æ—¶é®ç½© */
        #countdown-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center; justify-content: center; flex-direction: column;
            z-index: 100;
        }
        #cnt-num { font-size: 120px; font-weight: bold; color: #2ecc71; }
        #cnt-tip { font-size: 20px; margin-top: 20px; color: #ccc; }

        /* ç»“ç®—æŠ¥å‘Šé¢æ¿ */
        #report-panel {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; background: #fff; color: #333;
            padding: 30px; border-radius: 20px;
            display: none; flex-direction: column; gap: 15px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 200; text-align: center;
        }
        .stat-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .score-display { font-size: 48px; font-weight: bold; color: #2ecc71; margin: 10px 0; }
        .close-report { background: #333; color: white; margin-top: 10px; }

        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="visual-ring">
        <div style="font-size: 40px;">ğŸ‘ï¸</div>
    </div>
    <div id="status-text">ç­‰å¾…å¯åŠ¨</div>

    <video id="webcam" autoplay playsinline muted></video>

    <div id="controls">
        <button id="start-btn">å¼€å§‹ç›‘ç£</button>
        <button id="stop-btn">åœæ­¢ (éœ€å¯†ç )</button>
    </div>

    <div id="countdown-overlay">
        <div id="cnt-num">3</div>
        <div id="cnt-tip">è¯·ä¿æŒæ ‡å‡†å­¦ä¹ å§¿åŠ¿<br>ç³»ç»Ÿæ­£åœ¨æ ¡å‡†...</div>
    </div>

    <div id="report-panel">
        <h3>æœ¬æ¬¡å­¦ä¹ æŠ¥å‘Š</h3>
        <div class="score-display" id="final-score">98</div>
        <div class="stat-item"><span>â±ï¸ æ—¶é•¿</span><span id="stat-time">0åˆ†</span></div>
        <div class="stat-item"><span>ğŸ‘€ èµ°ç¥</span><span id="stat-distract">0æ¬¡</span></div>
        <div class="stat-item"><span>ğŸ¦´ å§¿æ€</span><span id="stat-posture">0æ¬¡</span></div>
        <div class="stat-item"><span>ğŸ‘» æ¶ˆå¤±</span><span id="stat-absent">0æ¬¡</span></div>
        <button class="close-report" onclick="location.reload()">é‡æ–°å¼€å§‹</button>
    </div>

    <script>
        // ================= é…ç½®åŒº =================
        const CONFIG = {
            // ç®¡ç†å‘˜å¯†ç 
            PASSWORD: "8888", 
            
            // åˆ¤å®šçµæ•åº¦ (åç¦»åŸºå‡†å¤šå°‘ç®—è¿è§„)
            threshold: {
                angle: 0.25, // å¤´éƒ¨è½¬åŠ¨/æŠ¬å¤´å¹…åº¦é˜ˆå€¼ (0-1)
                dist: 0.15   // å¤´éƒ¨ä½ç½®ç§»åŠ¨å¹…åº¦
            },
            
            checkInterval: 1000 // æ£€æµ‹é¢‘ç‡ (æ¯«ç§’)
        };

        const SPEECH = {
            start: "å§¿æ€å·²é”å®šï¼Œç›‘ç£å¼€å§‹ã€‚è¯·ä¿æŒä¸“æ³¨ã€‚",
            distracted: ["çœ‹å“ªå‘¢ï¼Ÿå›æ¥çœ‹ä¹¦ã€‚", "åˆ«ä¸œå¼ è¥¿æœ›ã€‚", "æ³¨æ„åŠ›é›†ä¸­ï¼"],
            posture: ["åå§¿å˜å½¢äº†ï¼Œè°ƒæ•´ä¸€ä¸‹ã€‚", "æ­ªä¸ƒæ‰­å…«çš„ï¼Œåç›´ï¼"],
            absent: ["äººå‘¢ï¼Ÿå¿«å›æ¥ï¼", "ä½ è¦å»å“ªï¼Ÿå­¦ä¹ è¿˜æ²¡ç»“æŸï¼"],
            stop: "ç›‘ç£ç»“æŸã€‚æ¥çœ‹æˆç»©å•ã€‚"
        };

        // ================= æ ¸å¿ƒå˜é‡ =================
        let faceLandmarker = null;
        let isRunning = false;
        let lastVideoTime = -1;
        let lastCheck = 0;
        
        // åŸºå‡†å§¿æ€ (æ ¡å‡†åå­˜å‚¨)
        let basePose = {
            yaw: 0,   // å·¦å³
            pitch: 0, // ä¸Šä¸‹
            roll: 0,  // æ­ªå¤´
            centerX: 0,
            centerY: 0
        };

        // æ•°æ®ç»Ÿè®¡
        let stats = {
            startTime: 0,
            distractCount: 0,
            postureCount: 0,
            absentCount: 0
        };

        // ================= åˆå§‹åŒ– =================
        async function initVision() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
            faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
                    delegate: "GPU" // ç¬”è®°æœ¬å¦‚æœæ²¡ç‹¬æ˜¾ä¼šè‡ªåŠ¨åˆ‡CPUï¼Œä¸ç”¨æ‹…å¿ƒ
                },
                outputFaceBlendshapes: true,
                runningMode: "VIDEO",
                numFaces: 1
            });
            document.getElementById('status-text').innerText = "è®¾å¤‡å°±ç»ª";
        }
        initVision();

        const video = document.getElementById('webcam');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');

        // ================= æµç¨‹æ§åˆ¶ =================
        
        // 1. ç‚¹å‡»å¼€å§‹ -> æ‰“å¼€æ‘„åƒå¤´ -> å€’è®¡æ—¶æ ¡å‡†
        startBtn.onclick = async () => {
            if (!faceLandmarker) return alert("æ¨¡å‹åŠ è½½ä¸­...");
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                video.srcObject = stream;
                startCalibration();
            } catch(e) {
                alert("æ— æ³•æ‰“å¼€æ‘„åƒå¤´ï¼Œè¯·å…è®¸æƒé™æˆ–ä½¿ç”¨HTTPS");
            }
        };

        // 2. å€’è®¡æ—¶æ ¡å‡†
        function startCalibration() {
            const overlay = document.getElementById('countdown-overlay');
            const numEl = document.getElementById('cnt-num');
            overlay.style.display = 'flex';
            
            let count = 3;
            numEl.innerText = count;
            speak("è¯·ä¿æŒæ ‡å‡†å­¦ä¹ åå§¿ï¼Œä¸‰ç§’åé”å®šã€‚");

            const timer = setInterval(() => {
                count--;
                numEl.innerText = count;
                if (count <= 0) {
                    clearInterval(timer);
                    overlay.style.display = 'none';
                    captureBasePose(); // ğŸ“¸ æ•æ‰å½“å‰å§¿åŠ¿ä½œä¸ºåŸºå‡†
                }
            }, 1000);
        }

        // 3. é”å®šåŸºå‡†å§¿æ€ (å…³é”®ç®—æ³•)
        function captureBasePose() {
            const now = Date.now();
            const results = faceLandmarker.detectForVideo(video, now);
            
            if (results.faceLandmarks.length > 0) {
                const lm = results.faceLandmarks[0];
                basePose = calculatePose(lm); // è®°å½•æ­¤åˆ»çš„å§¿æ€
                
                // å¯åŠ¨æ­£å¼ç›‘ç£
                isRunning = true;
                stats.startTime = Date.now();
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                document.body.className = "studying";
                document.getElementById('status-text').innerText = "ç›‘ç£è¿›è¡Œä¸­...";
                speak(SPEECH.start);
                
                predictLoop();
            } else {
                alert("æœªæ£€æµ‹åˆ°äººè„¸ï¼Œè¯·è°ƒæ•´å…‰çº¿æˆ–ä½ç½®é‡è¯•");
                startBtn.click(); // é‡è¯•
            }
        }

        // 4. åœæ­¢ç›‘ç£ (å¯†ç é”)
        stopBtn.onclick = () => {
            const pwd = prompt("è¯·è¾“å…¥å¯†ç åœæ­¢ç›‘ç£ï¼š");
            if (pwd === CONFIG.PASSWORD) {
                isRunning = false;
                showReport();
            } else {
                alert("å¯†ç é”™è¯¯ï¼Œè°ä¹Ÿåˆ«æƒ³è·‘ï¼");
                speak("å¯†ç é”™è¯¯ï¼Œç»§ç»­å­¦ä¹ ã€‚");
            }
        };

        // ================= æ ¸å¿ƒæ£€æµ‹å¾ªç¯ =================
        async function predictLoop() {
            if (!isRunning) return;
            
            const now = Date.now();
            if (now - lastCheck > CONFIG.checkInterval) {
                if (video.currentTime !== lastVideoTime) {
                    lastVideoTime = video.currentTime;
                    const results = faceLandmarker.detectForVideo(video, now);
                    analyzeBehavior(results);
                    lastCheck = now;
                }
            }
            requestAnimationFrame(predictLoop);
        }

        // ğŸ§  è¡Œä¸ºåˆ†æ (æ ¸å¿ƒé€»è¾‘)
        function analyzeBehavior(results) {
            // A. äººä¸åœ¨
            if (results.faceLandmarks.length === 0) {
                handleWarning("absent", "ğŸ‘» ç›®æ ‡ä¸¢å¤±");
                return;
            }

            const currentPose = calculatePose(results.faceLandmarks[0]);
            
            // è®¡ç®—åç¦»åº¦ (å½“å‰å§¿æ€ - åŸºå‡†å§¿æ€)
            const diffYaw = Math.abs(currentPose.yaw - basePose.yaw);     // å·¦å³è½¬å¤´å¹…åº¦
            const diffPitch = currentPose.pitch - basePose.pitch;         // æŠ¬å¤´å¹…åº¦ (æ³¨æ„æ–¹å‘)
            const diffRoll = Math.abs(currentPose.roll - basePose.roll);  // æ­ªå¤´å¹…åº¦
            
            // B. èµ°ç¥ (å¤§å¹…åº¦è½¬å¤´ æˆ– æŠ¬å¤´)
            // æ³¨æ„ï¼šä½å¤´å­¦ä¹ æ˜¯å…è®¸çš„ (pitch å˜å¤§)ï¼Œä½†æŠ¬å¤´çœ‹å±å¹•/å‘å‘†æ˜¯ä¸è¡Œçš„ (pitch å˜å°/è´Ÿæ•°)
            // è¿™é‡Œæˆ‘ä»¬ç®€å•åˆ¤å®šï¼šåªè¦ Yaw åç¦»å¤§ï¼Œæˆ–è€… Pitch åç¦»å¤§(æŠ¬å¤´)ï¼Œå°±æŠ¥è­¦
            
            if (diffYaw > CONFIG.threshold.angle) {
                handleWarning("distracted", "ğŸ‘€ åˆ«ä¸œå¼ è¥¿æœ›");
            } 
            // å¦‚æœ currentPitch æ¯” basePitch å°å¾ˆå¤šï¼Œè¯´æ˜æŠ¬å¤´äº†
            else if (diffPitch < -CONFIG.threshold.angle) {
                handleWarning("distracted", "ğŸ‘† åˆ«æŠ¬å¤´ï¼Œçœ‹ä¹¦");
            }
            // C. åå§¿ (æ­ªå¤´)
            else if (diffRoll > 20) { // 20åº¦ä»¥ä¸Š
                handleWarning("posture", "ğŸ¦´ åç›´äº†");
            } 
            else {
                // æ­£å¸¸
                document.body.className = "studying";
                document.getElementById('status-text').innerText = "ä¸“æ³¨ä¸­...";
            }
        }

        // ğŸ§® å‡ ä½•è®¡ç®—å·¥å…·
        function calculatePose(lm) {
            // ç®€å•å‡ ä½•ä¼°ç®—
            const nose = lm[1];
            const leftEye = lm[33];
            const rightEye = lm[263];
            
            // Yaw (å·¦å³): é¼»å°–åœ¨åŒçœ¼è¿çº¿ä¸Šçš„ç›¸å¯¹ä½ç½®
            const midX = (leftEye.x + rightEye.x) / 2;
            const yaw = nose.x - midX; 

            // Pitch (ä¸Šä¸‹): é¼»å°–ä¸çœ¼ç›çš„é«˜åº¦å·®
            const eyeY = (leftEye.y + rightEye.y) / 2;
            const pitch = nose.y - eyeY; 

            // Roll (æ—‹è½¬): åŒçœ¼è¿çº¿çš„æ–œç‡
            const dx = rightEye.x - leftEye.x;
            const dy = rightEye.y - leftEye.y;
            const roll = Math.atan2(dy, dx) * 180 / Math.PI;

            return { yaw, pitch, roll };
        }

        // ğŸš¨ è­¦å‘Šå¤„ç†
        let warnCooldown = 0;
        function handleWarning(type, text) {
            document.body.className = "warning";
            document.getElementById('status-text').innerText = text;
            
            // è®°å½•æ•°æ® (é˜²æŠ–ï¼Œ3ç§’è®°ä¸€æ¬¡)
            if (Date.now() > warnCooldown) {
                if(type === "distracted") stats.distractCount++;
                if(type === "posture") stats.postureCount++;
                if(type === "absent") stats.absentCount++;
                
                speak(pick(SPEECH[type]));
                warnCooldown = Date.now() + 5000; // 5ç§’å†·å´ï¼Œåˆ«éª‚å¤ªé¢‘ç¹
            }
        }

        // ğŸ“Š ç”ŸæˆæŠ¥å‘Š
        function showReport() {
            const durationMin = Math.floor((Date.now() - stats.startTime) / 60000);
            const totalWarnings = stats.distractCount + stats.postureCount + stats.absentCount;
            
            // ç®€å•çš„è¯„åˆ†å…¬å¼
            let score = 100 - (totalWarnings * 2);
            if (score < 0) score = 0;

            document.getElementById('stat-time').innerText = durationMin + " åˆ†é’Ÿ";
            document.getElementById('stat-distract').innerText = stats.distractCount + " æ¬¡";
            document.getElementById('stat-posture').innerText = stats.postureCount + " æ¬¡";
            document.getElementById('stat-absent').innerText = stats.absentCount + " æ¬¡";
            
            const scoreEl = document.getElementById('final-score');
            scoreEl.innerText = score;
            scoreEl.style.color = score > 80 ? "#2ecc71" : (score > 60 ? "#f1c40f" : "#e74c3c");

            document.getElementById('report-panel').style.display = 'flex';
            speak(SPEECH.stop + `ä½ çš„å¾—åˆ†æ˜¯ ${score} åˆ†ã€‚`);
        }

        // ğŸ”Š è¯­éŸ³åˆæˆ
        const synth = window.speechSynthesis;
        function speak(text) {
            if (!text) return;
            synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = "zh-CN"; u.rate = 1.2;
            synth.speak(u);
        }
        function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    </script>
</body>
</html>
