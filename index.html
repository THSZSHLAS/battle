<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>è“å±±å…¨èƒ½ç›‘ç£ç³»ç»Ÿ</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body { margin: 0; padding: 0; background-color: #1a1a1a; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: white; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }

        /* === æ ¸å¿ƒè§†è§‰ UIï¼šå‘¼å¸åœ†ç¯ === */
        #visual-ring { width: 220px; height: 220px; border: 8px solid #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative; background: rgba(0,0,0,0.2); z-index: 5; }
        
        /* çŠ¶æ€æ ·å¼ */
        body.studying #visual-ring { border-color: #2ecc71; box-shadow: 0 0 40px rgba(46, 204, 113, 0.4); animation: breathe 3s infinite ease-in-out; }
        body.warning #visual-ring { border-color: #e74c3c; background-color: rgba(231, 76, 60, 0.15); box-shadow: 0 0 60px rgba(231, 76, 60, 0.7); transform: scale(1.05); animation: pulse-red 0.8s infinite; }
        body.break #visual-ring { border-color: #3498db; background-color: rgba(52, 152, 219, 0.15); box-shadow: 0 0 40px rgba(52, 152, 219, 0.5); animation: none; transform: scale(0.95); }

        .icon { font-size: 60px; transition: all 0.3s; }
        #status-text { margin-top: 40px; font-size: 20px; font-weight: 400; opacity: 0.8; letter-spacing: 1px; text-align: center; height: 30px; transition: color 0.3s; z-index: 5; }
        body.warning #status-text { color: #ff7675; font-weight: bold; }

        /* === è§†é¢‘æº (äººè„¸) === */
        video#webcam { 
            position: absolute; top: 20px; right: 20px; width: 240px; height: 180px; 
            object-fit: cover; opacity: 0.8; border-radius: 12px; transform: scaleX(-1); 
            border: 2px solid #555; transition: all 0.3s; z-index: 150; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        video#webcam:hover { opacity: 1; border-color: #2ecc71; transform: scaleX(-1) scale(1.1); }

        /* === å±å¹•æº (éšè—ï¼Œåªç”¨äºè®¡ç®—) === */
        video#screen-video { display: none; }

        /* åº•éƒ¨æ§åˆ¶æ  */
        #controls { position: fixed; bottom: 40px; display: flex; gap: 15px; align-items: center; padding: 10px 20px; background: rgba(30,30,30,0.8); backdrop-filter: blur(10px); border-radius: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); padding-bottom: calc(10px + env(safe-area-inset-bottom)); z-index: 50; }
        
        button, select { padding: 12px 20px; border-radius: 25px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; outline: none; -webkit-appearance: none; }
        button:active { transform: scale(0.92); }
        
        #screen-btn { background: #3498db; color: #fff; } /* è“è‰² */
        #start-btn { background: #2ecc71; color: #fff; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4); } /* ç»¿è‰² */
        #stop-btn { background: #ff4757; color: #fff; display: none; }
        #break-btn { background: #f1c40f; color: #000; display: none; }
        
        #mode-select { background: #444; color: #fff; padding-right: 30px; text-align: center; border: 1px solid #555; }

        /* æ ¡å‡†é®ç½© */
        #countdown-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 100; padding: 20px; box-sizing: border-box; }
        #cnt-num { font-size: 28px; font-weight: bold; color: #2ecc71; margin-bottom: 30px; margin-top: 150px; }
        .calib-section { margin-bottom: 25px; width: 100%; max-width: 320px; text-align: center; }
        .calib-desc { font-size: 16px; color: #eee; margin-bottom: 10px; }
        .calib-btn { width: 100%; padding: 14px; background: #333; border: 1px solid #555; color: #fff; }
        .calib-btn.done { background: #2ecc71; border-color: #2ecc71; color: #fff; }
        .calib-status { font-size: 12px; margin-top: 5px; color: #777; height: 16px; }
        
        #calib-start-study-btn { background: linear-gradient(135deg, #2ecc71, #27ae60); width: 100%; margin-top: 20px; font-size: 18px; padding: 16px; opacity: 0.5; pointer-events: none; transition: opacity 0.3s; }
        #calib-start-study-btn.ready { opacity: 1; pointer-events: auto; box-shadow: 0 0 20px rgba(46, 204, 113, 0.4); transform: scale(1.05); }

        /* æŠ¥å‘Šé¢æ¿ */
        #report-panel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); width: 320px; max-width: 90%; background: #222; color: #fff; padding: 30px; border-radius: 24px; display: none; flex-direction: column; gap: 15px; box-shadow: 0 25px 60px rgba(0,0,0,0.8); z-index: 200; text-align: center; border: 1px solid #333; opacity: 0; transition: all 0.3s; }
        #report-panel.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .score-display { font-size: 60px; font-weight: 800; color: #2ecc71; line-height: 1; margin: 10px 0; text-shadow: 0 0 20px rgba(46, 204, 113, 0.3); }
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 8px 0; font-size: 14px; color: #aaa; }
        .stat-val { color: #fff; font-weight: bold; }
        .close-report { background: #444; color: white; margin-top: 15px; width: 100%; }

        @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.05); opacity: 1; } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
    </style>
</head>
<body>

    <div id="visual-ring">
        <div class="icon" id="status-icon">ğŸ‘ï¸</div>
    </div>
    <div id="status-text">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>

    <video id="webcam" autoplay playsinline muted></video>
    <video id="screen-video" autoplay playsinline muted></video>

    <div id="controls">
        <select id="mode-select">
            <option value="easy">è½»æ¾æ¨¡å¼</option>
            <option value="normal" selected>æ ‡å‡†æ¨¡å¼</option>
            <option value="hard">ç¡¬æ ¸æ¨¡å¼</option>
        </select>
        <button id="screen-btn">â‘  æ¥å…¥å±å¹•</button>
        <button id="start-btn" disabled>â‘¡ æ¥å…¥äººè„¸</button>
        <button id="break-btn">ä¼‘æ¯</button>
        <button id="stop-btn">åœæ­¢</button>
    </div>

    <div id="countdown-overlay">
        <div id="cnt-num">è¯·çœ‹ç€å³ä¸Šè§’è§†é¢‘æ ¡å‡†</div>
        
        <div class="calib-section">
            <button id="calib-screen-btn" class="calib-btn">â‘  é”å®šâ€œçœ‹å±å¹•â€å§¿åŠ¿</button>
            <div id="calib-screen-status" class="calib-status"></div>
        </div>
        
        <div class="calib-section">
            <button id="calib-book-btn" class="calib-btn">â‘¡ (å¯é€‰) é”å®šâ€œçœ‹ä¹¦â€å§¿åŠ¿</button>
            <div id="calib-book-status" class="calib-status"></div>
        </div>

        <button id="calib-start-study-btn" class="calib-btn">å¼€å§‹å…¨æ™¯ç›‘ç£</button>
        <div style="font-size:12px; color:#666; margin-top:15px;">* è¯·ç¡®ä¿æ­¤æ—¶å±å¹•ä¸Šæ˜¾ç¤ºçš„æ˜¯å­¦ä¹ å†…å®¹</div>
    </div>

    <div id="report-panel">
        <div style="font-size:14px; color:#888;">æœ¬æ¬¡ä¸“æ³¨è¯„åˆ†</div>
        <div class="score-display" id="final-score">0</div>
        
        <div class="stat-row"><span>â±ï¸ ä¸“æ³¨æ—¶é•¿</span><span class="stat-val" id="stat-time">0åˆ†</span></div>
        <div class="stat-row"><span>ğŸ‘€ è§†çº¿åç¦»</span><span class="stat-val" id="stat-distract">0æ¬¡</span></div>
        <div class="stat-row"><span>ğŸ¦´ åå§¿æé†’</span><span class="stat-val" id="stat-posture">0æ¬¡</span></div>
        <div class="stat-row"><span>ğŸ® å±å¹•æ‘¸é±¼</span><span class="stat-val" id="stat-screen">0æ¬¡</span></div>
        <div class="stat-row"><span>ğŸ‘» ç¦»å¼€ç”»é¢</span><span class="stat-val" id="stat-absent">0æ¬¡</span></div>
        
        <button class="close-report" id="restart-btn">é‡æ–°å¼€å§‹</button>
    </div>

    <script type="module">
        import { FilesetResolver, FaceLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js";

        // ================= é…ç½®ä¸­å¿ƒ =================
        const CONFIG = {
            PASSWORD: "8888",
            checkInterval: 1000, 
            
            // äººè„¸é˜ˆå€¼
            threshold: { angle: 0.25, rollDeg: 20 },
            durations: { distractedMs: 3000, absentMs: 5000 },
            
            // å±å¹•é˜ˆå€¼ (å¼ºåŒ–çµæ•åº¦)
            screen: {
                diffThreshold: 20, // åªè¦è¶…è¿‡20ä¸ªåƒç´ ç‚¹å‰§çƒˆå˜åŒ–å°±ç®—åŠ¨äº† (éå¸¸çµæ•)
                triggerCount: 8    // è¿ç»­ 8 æ¬¡æ£€æµ‹(çº¦8ç§’)éƒ½åœ¨åŠ¨ -> åˆ¤å®šçœ‹è§†é¢‘
            },

            // åˆ†æ•°æƒé‡
            score: { base: 60, focusPerSec: 0.015, distractPen: 1.5, posturePen: 1.2, absentPen: 3, screenPen: 5 }
        };

        const SPEECH = {
            start: "å…¨æ™¯ç›‘ç£å¯åŠ¨ï¼Œè¯·ä¿æŒå­¦ä¹ ã€‚",
            focusAgain: ["çŠ¶æ€å›æ¥äº†ï¼Œå¾ˆå¥½ã€‚", "ä¿æŒä¸“æ³¨ã€‚", "ç»§ç»­åŠ æ²¹ã€‚"],
            distracted: ["çœ‹å“ªå‘¢ï¼Ÿå›æ¥çœ‹ä¹¦ã€‚", "åˆ«ä¸œå¼ è¥¿æœ›ã€‚", "æ³¨æ„åŠ›é›†ä¸­ï¼"],
            posture: ["åç›´äº†ï¼è…°ä¸è¦äº†ï¼Ÿ", "åå¥½ã€‚", "è„Šæ¤è­¦å‘Šï¼"],
            absent: ["äººå‘¢ï¼Ÿå»å“ªäº†ï¼Ÿ", "å¿«å›æ¥å­¦ä¹ ï¼", "ç›®æ ‡ä¸¢å¤±ã€‚"],
            gaming: ["å±å¹•ä¸€ç›´åœ¨é—ªï¼Œæ˜¯åœ¨çœ‹è§†é¢‘å—ï¼Ÿ", "æ£€æµ‹åˆ°å¨±ä¹æ´»åŠ¨ï¼Œè¯·åˆ‡å›å­¦ä¹ ã€‚", "åˆ«æ‘¸é±¼äº†ï¼Œå…³æ‰è§†é¢‘ã€‚"],
            breakStart: ["ä¼‘æ¯ä¸€ä¸‹ï¼Œæ´»åŠ¨çœ¼ç›ã€‚", "ä¼‘æ¯å¼€å§‹ã€‚"],
            breakEnd: ["ä¼‘æ¯ç»“æŸï¼Œå›æ¥ä¸“æ³¨ã€‚", "å¥½äº†ï¼Œæ”¶å¿ƒç»§ç»­ã€‚"],
            stop: "ç›‘ç£ç»“æŸã€‚æ¥çœ‹ä½ çš„æˆç»©å•ã€‚"
        };

        // ================= çŠ¶æ€å˜é‡ =================
        let faceLandmarker = null;
        let isRunning = false;
        let currentState = "IDLE"; // IDLE, FOCUSED, DISTRACTED, ABSENT, BREAK, GAMING
        let lastVideoTime = -1;
        let lastCheck = 0;
        
        // å§¿æ€åŸºå‡†
        let baseScreenPose = null;
        let baseBookPose = null;

        // è®¡æ—¶å™¨
        let awayStartTime = null;
        let absentStartTime = null;

        // å±å¹•ç›‘æ§å˜é‡
        let screenStream = null;
        let screenCanvas = document.createElement('canvas');
        let screenCtx = screenCanvas.getContext('2d');
        let lastScreenData = null;
        let screenActivityCounter = 0;

        // ç»Ÿè®¡æ•°æ®
        let stats = { startTime: 0, distractCount: 0, postureCount: 0, absentCount: 0, screenCount: 0, score: CONFIG.score.base };

        // DOM å…ƒç´ 
        const els = {
            webcam: document.getElementById('webcam'),
            screenVideo: document.getElementById('screen-video'),
            startBtn: document.getElementById('start-btn'),
            screenBtn: document.getElementById('screen-btn'),
            stopBtn: document.getElementById('stop-btn'),
            breakBtn: document.getElementById('break-btn'),
            statusText: document.getElementById('status-text'),
            statusIcon: document.getElementById('status-icon'),
            modeSelect: document.getElementById('mode-select'),
            overlay: document.getElementById('countdown-overlay'),
            report: document.getElementById('report-panel')
        };

        // ================= åˆå§‹åŒ– =================
        async function init() {
            try {
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
                faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
                        delegate: "GPU"
                    },
                    outputFaceBlendshapes: true, runningMode: "VIDEO", numFaces: 1
                });
                els.statusText.innerText = "è®¾å¤‡å°±ç»ª";
            } catch (e) {
                console.error(e);
                els.statusText.innerText = "æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ";
            }
        }
        init();

        // ================= æ ¸å¿ƒæµç¨‹ =================
        
        // 1. æ¥å…¥å±å¹• (å¿…é¡»å…ˆåš)
        els.screenBtn.onclick = async () => {
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "always" }, audio: false });
                els.screenVideo.srcObject = screenStream;
                
                // æŒ‰é’®å˜ç»¿
                els.screenBtn.innerText = "âœ… å±å¹•å·²æ¥å…¥";
                els.screenBtn.style.background = "#2ecc71";
                els.startBtn.disabled = false;

                // ç›‘å¬åœæ­¢å…±äº«
                screenStream.getVideoTracks()[0].onended = () => {
                    alert("å±å¹•å…±äº«å·²åœæ­¢ï¼Œç›‘ç£ä¸­æ­¢ï¼");
                    location.reload();
                };
            } catch(e) {
                alert("è¯·å…ˆé€‰æ‹©åˆ†äº«å±å¹• (æ¨èé€‰æ‹©'æ•´ä¸ªå±å¹•')");
            }
        };

        // 2. æ‰“å¼€æ‘„åƒå¤´ (å¿…é¡»ååš)
        els.startBtn.onclick = async () => {
            if (!faceLandmarker) return;
            if (!screenStream) { alert("è¯·å…ˆæ¥å…¥å±å¹•ï¼"); return; }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: "user" } });
                els.webcam.srcObject = stream;
                els.webcam.onloadeddata = () => {
                    els.overlay.style.display = 'flex';
                    speak("è¯·è¿›è¡Œå§¿æ€æ ¡å‡†ã€‚");
                };
            } catch(e) {
                alert("æ— æ³•æ‰“å¼€æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿ä½¿ç”¨ HTTPS åè®®æˆ–æœ¬åœ° localhostã€‚");
            }
        };

        // 3. æ ¡å‡†é€»è¾‘
        function capturePose() {
            const now = performance.now();
            const res = faceLandmarker.detectForVideo(els.webcam, now);
            if (res && res.faceLandmarks.length > 0) {
                return calculatePose(res.faceLandmarks[0]);
            }
            return null;
        }

        document.getElementById('calib-screen-btn').onclick = function() {
            const pose = capturePose();
            if (pose) {
                baseScreenPose = pose;
                this.classList.add('done');
                this.innerText = "å·²é”å®š (çœ‹å±å¹•) âœ…";
                checkCalibReady();
                speak("å±å¹•å§¿æ€å·²é”å®šã€‚");
            } else alert("æœªæ£€æµ‹åˆ°äººè„¸ï¼Œè¯·çœ‹ç€å³ä¸Šè§’è§†é¢‘ã€‚");
        };

        document.getElementById('calib-book-btn').onclick = function() {
            const pose = capturePose();
            if (pose) {
                baseBookPose = pose;
                this.classList.add('done');
                this.innerText = "å·²é”å®š (çœ‹ä¹¦æœ¬) âœ…";
                checkCalibReady();
                speak("ä¹¦æœ¬å§¿æ€å·²é”å®šã€‚");
            } else alert("æœªæ£€æµ‹åˆ°äººè„¸ï¼Œè¯·çœ‹ç€å³ä¸Šè§’è§†é¢‘ã€‚");
        };

        function checkCalibReady() {
            if (baseScreenPose || baseBookPose) { 
                const btn = document.getElementById('calib-start-study-btn');
                btn.classList.add('ready');
                btn.disabled = false;
            }
        }

        document.getElementById('calib-start-study-btn').onclick = () => {
            if (!baseScreenPose && !baseBookPose) return;
            els.overlay.style.display = 'none';
            startSession();
        };

        function startSession() {
            applyMode(els.modeSelect.value);
            stats = { startTime: Date.now(), distractCount: 0, postureCount: 0, absentCount: 0, screenCount: 0, score: CONFIG.score.base };
            isRunning = true;
            currentState = "FOCUSED";
            
            els.startBtn.style.display = 'none';
            els.screenBtn.style.display = 'none';
            els.modeSelect.style.display = 'none';
            els.breakBtn.style.display = 'block';
            els.stopBtn.style.display = 'block';
            
            updateUI("studying", "ğŸ“–", "ç›‘ç£è¿›è¡Œä¸­...");
            speak(SPEECH.start);
            loop();
        }

        // ================= å¾ªç¯æ£€æµ‹ =================
        async function loop() {
            if (!isRunning) return;
            if (currentState === "BREAK") { requestAnimationFrame(loop); return; }

            const now = performance.now();
            if (now - lastCheck > CONFIG.checkInterval) {
                
                // 1. å±å¹•æ£€æµ‹ (ç‹¬ç«‹é€»è¾‘)
                analyzeScreen();

                // 2. äººè„¸æ£€æµ‹
                if (els.webcam.currentTime !== lastVideoTime) {
                    lastVideoTime = els.webcam.currentTime;
                    const res = faceLandmarker.detectForVideo(els.webcam, now);
                    analyzeFace(res);
                }
                
                lastCheck = now;
            }
            requestAnimationFrame(loop);
        }

        // ================= å±å¹•åˆ†æ (å¢å¼ºç‰ˆ) =================
        function analyzeScreen() {
            if (!screenStream) return;

            // 1. é™é‡‡æ ·åˆ° 64x48ï¼Œè¶³å¤Ÿæ£€æµ‹è¿åŠ¨ï¼Œä¸”æ€§èƒ½å¼€é”€æä½
            const w = 64, h = 48;
            screenCanvas.width = w; screenCanvas.height = h;
            screenCtx.drawImage(els.screenVideo, 0, 0, w, h);
            
            const frame = screenCtx.getImageData(0, 0, w, h);
            const data = frame.data;

            if (!lastScreenData) { lastScreenData = data; return; }

            // 2. è®¡ç®—å·®å¼‚
            let diffScore = 0;
            // æ­¥é•¿ 8 (æ¯éš”2ä¸ªåƒç´ æ£€æµ‹ä¸€ä¸ª)ï¼Œå…¼é¡¾é€Ÿåº¦å’Œç²¾åº¦
            for (let i = 0; i < data.length; i += 8) {
                const diff = Math.abs(data[i] - lastScreenData[i]) + 
                             Math.abs(data[i+1] - lastScreenData[i+1]) + 
                             Math.abs(data[i+2] - lastScreenData[i+2]);
                if (diff > 50) diffScore++; // åªè¦é¢œè‰²å˜åŒ–è¶…è¿‡ 50 (å¾ˆå°çš„å˜åŒ–) å°±è®¡å…¥
            }
            lastScreenData = data;

            // 3. åˆ¤å®š
            // é˜ˆå€¼ï¼šCONFIG.screen.diffThreshold (20)ã€‚åªè¦æœ‰ 20 ä¸ªé‡‡æ ·ç‚¹åŠ¨äº†å°±ç®—åŠ¨ã€‚
            if (diffScore > CONFIG.screen.diffThreshold) {
                screenActivityCounter++;
            } else {
                // ç¼“æ…¢å†·å´ï¼Œé˜²æ­¢æˆ‘çœ‹ä¸€ä¼šè§†é¢‘åœä¸€ä¸‹å°±æ¼åˆ¤
                screenActivityCounter = Math.max(0, screenActivityCounter - 1);
            }

            // 4. æŠ¥è­¦
            if (screenActivityCounter > CONFIG.screen.triggerCount) {
                handleStateChange("GAMING");
                // æŠ¥è­¦åç¨å¾®é‡ç½®ä¸€ä¸‹ï¼Œé¿å…ä¸€ç›´é‡å¤æŠ¥è­¦å¤ªé¢‘ç¹
                screenActivityCounter = Math.max(0, screenActivityCounter - 4); 
            }
        }

        // ================= äººè„¸åˆ†æ =================
        function analyzeFace(results) {
            // å¦‚æœå±å¹•æ­£åœ¨æŠ¥è­¦ï¼Œå…ˆä¸æŠ¥äººè„¸ï¼Œé¿å…å†²çª
            if (currentState === "GAMING") return;

            if (!results || !results.faceLandmarks || results.faceLandmarks.length === 0) {
                handleStateChange("ABSENT");
                return;
            }
            absentStartTime = null;

            const lm = results.faceLandmarks[0];
            const currentPose = calculatePose(lm);

            let isGoodPose = false;
            if (baseScreenPose && checkPoseMatch(currentPose, baseScreenPose)) isGoodPose = true;
            if (!isGoodPose && baseBookPose && checkPoseMatch(currentPose, baseBookPose)) isGoodPose = true;

            if (isGoodPose) {
                handleStateChange("FOCUSED");
            } else {
                const diffRoll = baseScreenPose ? Math.abs(currentPose.roll - baseScreenPose.roll) : 0;
                if (diffRoll > CONFIG.threshold.rollDeg) {
                    handleStateChange("POSTURE_BAD");
                } else {
                    handleStateChange("DISTRACTED");
                }
            }
        }

        // ================= çŠ¶æ€æœº =================
        function handleStateChange(newState) {
            // 1. ä¸“æ³¨åŠ åˆ†
            if (newState === "FOCUSED") {
                stats.score += CONFIG.score.focusPerSec * (CONFIG.checkInterval/1000);
                if (stats.score > 100) stats.score = 100;
                
                // ä»åçŠ¶æ€æ¢å¤
                if (currentState !== "FOCUSED") {
                    updateUI("studying", "ğŸ“–", "ä¸“æ³¨ä¸­...");
                    awayStartTime = null;
                    if (["DISTRACTED", "POSTURE_BAD", "ABSENT", "GAMING"].includes(currentState)) {
                        speak(pick(SPEECH.focusAgain));
                    }
                }
                currentState = "FOCUSED";
                return;
            }

            // 2. å±å¹•æ‘¸é±¼ (æœ€é«˜ä¼˜å…ˆçº§æŠ¥è­¦)
            if (newState === "GAMING") {
                if (currentState !== "GAMING") {
                    stats.screenCount++;
                    stats.score -= CONFIG.score.screenPen;
                    updateUI("warning", "ğŸ®", "å±å¹•é—ªçƒå¤ªå¿«ï¼");
                    speak(pick(SPEECH.gaming));
                    currentState = "GAMING";
                }
                return;
            }

            // 3. äººè„¸å¼‚å¸¸ (å¸¦ç¼“å†²)
            if (!awayStartTime) awayStartTime = Date.now();
            const elapsed = Date.now() - awayStartTime;
            const limit = (newState === "ABSENT") ? CONFIG.durations.absentMs : CONFIG.durations.distractedMs;

            if (elapsed > limit) {
                if (currentState !== newState) {
                    currentState = newState;
                    if (newState === "DISTRACTED") {
                        stats.distractCount++;
                        stats.score -= CONFIG.score.distractPen;
                        updateUI("warning", "ğŸ‘€", "åˆ«ä¸œå¼ è¥¿æœ›");
                        speak(pick(SPEECH.distracted));
                    } else if (newState === "POSTURE_BAD") {
                        stats.postureCount++;
                        stats.score -= CONFIG.score.posturePen;
                        updateUI("warning", "ğŸ¦´", "åç›´äº†ï¼");
                        speak(pick(SPEECH.posture));
                    } else if (newState === "ABSENT") {
                        stats.absentCount++;
                        stats.score -= CONFIG.score.absentPen;
                        updateUI("warning", "ğŸ‘»", "äººå‘¢ï¼Ÿå¿«å›æ¥");
                        speak(pick(SPEECH.absent));
                    }
                    if (stats.score < 0) stats.score = 0;
                }
            } else {
                document.body.className = "studying";
                els.statusText.innerText = "è°ƒæ•´ä¸­...";
            }
        }

        // ================= è¾…åŠ©å‡½æ•° =================
        function calculatePose(lm) {
            const nose = lm[1], leftEye = lm[33], rightEye = lm[263];
            const midX = (leftEye.x + rightEye.x) / 2;
            const eyeY = (leftEye.y + rightEye.y) / 2;
            const yaw = nose.x - midX; 
            const pitch = nose.y - eyeY; 
            const dx = rightEye.x - leftEye.x;
            const dy = rightEye.y - leftEye.y;
            const roll = Math.atan2(dy, dx) * 180 / Math.PI;
            return { yaw, pitch, roll };
        }

        function checkPoseMatch(curr, base) {
            const dYaw = Math.abs(curr.yaw - base.yaw);
            const dPitch = Math.abs(curr.pitch - base.pitch);
            const dRoll = Math.abs(curr.roll - base.roll);
            return (dYaw < CONFIG.threshold.angle && dPitch < CONFIG.threshold.angle && dRoll < CONFIG.threshold.rollDeg);
        }

        function updateUI(cls, icon, text) {
            document.body.className = cls;
            els.statusIcon.innerText = icon;
            els.statusText.innerText = text;
        }

        function applyMode(mode) {
            if (mode === "easy") { CONFIG.threshold.angle = 0.35; CONFIG.durations.distractedMs = 4000; }
            else if (mode === "hard") { CONFIG.threshold.angle = 0.15; CONFIG.durations.distractedMs = 1500; }
            else { CONFIG.threshold.angle = 0.25; CONFIG.durations.distractedMs = 3000; }
        }

        // ================= æŒ‰é’®é€»è¾‘ =================
        els.stopBtn.onclick = () => {
            const pwd = prompt("è¯·è¾“å…¥å¯†ç åœæ­¢ç›‘ç£ï¼š");
            if (pwd === CONFIG.PASSWORD) {
                isRunning = false;
                if (els.webcam.srcObject) els.webcam.srcObject.getTracks().forEach(t => t.stop());
                if (screenStream) screenStream.getTracks().forEach(t => t.stop());
                
                // ä¿®å¤ï¼šæ˜¾å¼è®¾ç½®ä¸º Flex
                els.report.style.display = 'flex';
                setTimeout(() => els.report.classList.add('show'), 10);
                showReport();
            } else {
                alert("å¯†ç é”™è¯¯ï¼"); speak("å¯†ç é”™è¯¯ï¼Œè°ä¹Ÿåˆ«æƒ³è·‘ã€‚");
            }
        };

        function showReport() {
            const durationMs = Date.now() - stats.startTime;
            const durationMin = Math.max(1, Math.round(durationMs / 60000));
            document.getElementById('stat-time').innerText = durationMin + " åˆ†é’Ÿ";
            document.getElementById('stat-distract').innerText = stats.distractCount + " æ¬¡";
            document.getElementById('stat-posture').innerText = stats.postureCount + " æ¬¡";
            document.getElementById('stat-absent').innerText = stats.absentCount + " æ¬¡";
            document.getElementById('stat-screen').innerText = stats.screenCount + " æ¬¡";
            const finalScore = Math.round(Math.max(0, Math.min(100, stats.score)));
            document.getElementById('final-score').innerText = finalScore;
            
            const scoreEl = document.getElementById('final-score');
            if (finalScore >= 85) scoreEl.style.color = "#2ecc71";
            else if (finalScore >= 70) scoreEl.style.color = "#f1c40f";
            else scoreEl.style.color = "#e74c3c";
            
            speak(SPEECH.stop + `ä½ çš„ä¸“æ³¨ç§¯åˆ†æ˜¯ ${finalScore} åˆ†ã€‚`);
        }

        els.breakBtn.onclick = () => {
            if (currentState === "BREAK") {
                currentState = "FOCUSED"; awayStartTime = null; screenActivityCounter = 0;
                els.breakBtn.innerText = "ä¼‘æ¯"; els.stopBtn.style.display = "block";
                updateUI("studying", "ğŸ“–", "æ¬¢è¿å›æ¥"); speak(pick(SPEECH.breakEnd));
            } else {
                currentState = "BREAK";
                els.breakBtn.innerText = "ç»“æŸä¼‘æ¯"; els.stopBtn.style.display = "none";
                updateUI("break", "â˜•", "ä¼‘æ¯ä¸­..."); speak(pick(SPEECH.breakStart));
            }
        };

        document.getElementById('restart-btn').onclick = () => location.reload();

        const synth = window.speechSynthesis;
        function speak(text) {
            if (!text || !synth) return;
            synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = "zh-CN"; u.rate = 1.2;
            synth.speak(u);
        }
        function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        document.body.addEventListener('click', () => { if(synth) synth.speak(new SpeechSynthesisUtterance(" ")); }, {once:true});
    </script>
</body>
</html>
