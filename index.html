<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>æ±¤è‡£å­¦ä¹ ç›‘ç£ç³»ç»Ÿ6.0</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body { margin: 0; padding: 0; background-color: #111; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: white; overflow: hidden; user-select: none; }

        /* === æ ¸å¿ƒè§†è§‰ UIï¼šä¸“æ³¨æ ‘ === */
        #visual-container { position: relative; width: 260px; height: 260px; display: flex; align-items: center; justify-content: center; z-index: 5; }
        
        /* å‘¼å¸å…‰ç¯ */
        #visual-ring { position: absolute; width: 100%; height: 100%; border: 4px solid #333; border-radius: 50%; transition: all 0.5s; pointer-events: none; }
        
        /* æ ‘è‹— Emoji/Icon */
        #plant-icon { font-size: 100px; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 6; text-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* çŠ¶æ€æ ·å¼ */
        body.studying #visual-ring { border-color: #2ecc71; box-shadow: 0 0 50px rgba(46, 204, 113, 0.3); animation: breathe 4s infinite ease-in-out; }
        body.studying #plant-icon { transform: scale(1.1); filter: drop-shadow(0 0 20px rgba(46, 204, 113, 0.6)); }
        
        body.warning #visual-ring { border-color: #e74c3c; background: rgba(231, 76, 60, 0.1); box-shadow: 0 0 80px rgba(231, 76, 60, 0.6); animation: shake 0.5s infinite; }
        body.warning #plant-icon { transform: scale(0.9) rotate(-10deg); filter: grayscale(100%) sepia(100%) hue-rotate(-50deg) saturate(300%); }

        /* çŠ¶æ€æ–‡å­— */
        #status-text { margin-top: 20px; font-size: 18px; color: #888; letter-spacing: 1px; text-align: center; height: 24px; z-index: 5; }

        /* === ç›‘æ§çª—å£ === */
        .preview-container { position: absolute; top: 15px; display: flex; gap: 10px; z-index: 10; width: 90%; justify-content: center; }
        .mini-video { width: 120px; height: 90px; background: #000; border: 1px solid #444; border-radius: 8px; overflow: hidden; position: relative; opacity: 0.7; transition: 0.3s; }
        .mini-video.active { opacity: 1; border-color: #2ecc71; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #webcam { transform: scaleX(-1); }
        #screen-video { object-fit: contain; }
        
        /* çƒ­åº¦æ¡ */
        #activity-bar { position: absolute; bottom: 0; left: 0; height: 4px; background: #2ecc71; width: 0%; transition: width 0.2s; }

        /* åº•éƒ¨æ§åˆ¶ */
        #controls { position: fixed; bottom: 40px; display: flex; gap: 12px; align-items: center; padding: 12px 20px; background: rgba(30,30,30,0.9); border-radius: 40px; z-index: 50; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        button { padding: 10px 20px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px; }
        button:active { transform: scale(0.95); }
        #start-btn { background: #2ecc71; color: #fff; }
        #stop-btn { background: #ff4757; color: #fff; display: none; }
        #history-btn { background: #333; color: #ccc; border: 1px solid #555; }

        /* é®ç½©é€šç”¨ */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: none; align-items: center; justify-content: center; flex-direction: column; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); }
        
        /* å†å²è®°å½•é¢æ¿ */
        #history-panel { align-items: flex-start; padding: 0; }
        .panel-content { width: 90%; max-width: 400px; height: 80%; background: #1e1e1e; border-radius: 20px; padding: 20px; overflow-y: auto; margin: auto; border: 1px solid #333; display: flex; flex-direction: column; }
        .history-card { background: #2a2a2a; border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #555; }
        .history-card.good { border-left-color: #2ecc71; }
        .history-card.bad { border-left-color: #e74c3c; }
        .h-date { font-size: 12px; color: #888; margin-bottom: 5px; }
        .h-score { font-size: 24px; font-weight: bold; color: white; float: right; }
        .h-imgs { display: flex; gap: 5px; margin-top: 10px; overflow-x: auto; }
        .h-imgs img { width: 60px; height: 45px; object-fit: cover; border-radius: 4px; border: 1px solid #444; }

        /* æ ¡å‡†æŒ‰é’®æ ·å¼ */
        .calib-btn { padding: 15px; margin: 8px; background: #333; color: white; border: 1px solid #555; width: 280px; text-align: left; border-radius: 12px; }
        .calib-btn.done { background: #2ecc71; border-color: #2ecc71; }
        
        @keyframes breathe { 0%,100%{transform:scale(1); opacity:0.5;} 50%{transform:scale(1.1); opacity:1;} }
        @keyframes shake { 0%{transform:translate(1px, 1px) rotate(0deg);} 10%{transform:translate(-1px, -2px) rotate(-1deg);} 20%{transform:translate(-3px, 0px) rotate(1deg);} 30%{transform:translate(3px, 2px) rotate(0deg);} 40%{transform:translate(1px, -1px) rotate(1deg);} 50%{transform:translate(-1px, 2px) rotate(-1deg);} 60%{transform:translate(-3px, 1px) rotate(0deg);} 70%{transform:translate(3px, 1px) rotate(-1deg);} 80%{transform:translate(-1px, -1px) rotate(1deg);} 90%{transform:translate(1px, 2px) rotate(0deg);} 100%{transform:translate(1px, -2px) rotate(-1deg);} }
    </style>
</head>
<body>

    <div class="preview-container">
        <div class="mini-video" id="screen-box">
            <video id="screen-video" autoplay playsinline muted></video>
            <div id="activity-bar"></div>
        </div>
        <div class="mini-video" id="cam-box">
            <video id="webcam" autoplay playsinline muted></video>
        </div>
    </div>

    <div id="visual-container">
        <div id="visual-ring"></div>
        <div id="plant-icon">ğŸŒ±</div>
    </div>
    <div id="status-text">ç³»ç»Ÿåˆå§‹åŒ–...</div>

    <div id="controls">
        <button id="screen-btn">â‘  å±å¹•</button>
        <button id="start-btn" disabled>â‘¡ äººè„¸</button>
        <button id="history-btn">ğŸ“œ å†å²</button>
        <button id="stop-btn">åœæ­¢</button>
    </div>

    <div id="calib-overlay" class="overlay">
        <h2 style="color:white;">å§¿æ€æ ¡å‡†</h2>
        <button id="calib-screen-btn" class="calib-btn">â‘  é”å®šâ€œçœ‹å±å¹•â€å§¿åŠ¿</button>
        <button id="calib-book-btn" class="calib-btn">â‘¡ (å¯é€‰) é”å®šâ€œçœ‹ä¹¦â€å§¿åŠ¿</button>
        <button id="calib-done-btn" class="calib-btn" style="background: linear-gradient(135deg, #2ecc71, #27ae60); text-align:center; margin-top:20px; opacity:0.5; pointer-events:none;">å¼€å§‹ç§æ ‘ (ç›‘ç£)</button>
    </div>

    <div id="history-overlay" class="overlay">
        <div class="panel-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">å­¦ä¹ æ¡£æ¡ˆ</h2>
                <button onclick="document.getElementById('history-overlay').style.display='none'" style="background:#333; padding:5px 15px;">å…³é—­</button>
            </div>
            <div id="history-list">
                </div>
            <button id="clear-history" style="margin-top:20px; background:#e74c3c;">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
        </div>
    </div>

    <script type="module">
        import { FilesetResolver, FaceLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js";

        // ================= é…ç½® =================
        const CONFIG = {
            PASSWORD: "8888",
            checkInterval: 1000,
            threshold: { angle: 0.35, roll: 25, eyeClose: 0.5 }, // çœ¼ç›é—­åˆåº¦é˜ˆå€¼ (0-1)
            durations: { distracted: 3000, absent: 0, sleep: 2000 }, // é—­çœ¼2ç§’æŠ¥è­¦
            screen: { diff: 10, heatUp: 10, cool: 5, trigger: 160, max: 200 },
            score: { base: 60, perSec: 0.02, penDistract: 2, penScreen: 5, penAbsent: 5, penSleep: 8 },
            plants: ["ğŸŒ±", "ğŸŒ¿", "ğŸª´", "ğŸŒ²", "ğŸŒ³", "ğŸ"] // æˆé•¿é˜¶æ®µ
        };

        const SPEECH = {
            start: "ç§å­å·²ç§ä¸‹ï¼Œä¸“æ³¨è®©å®ƒå‘èŠ½ã€‚",
            focus: ["å¾ˆå¥½ï¼Œæ ‘åœ¨é•¿é«˜ã€‚", "ä¿æŒè¿™ä¸ªçŠ¶æ€ã€‚"],
            warn: ["åˆ«ä¹±åŠ¨ï¼Œæ ‘å¶åœ¨æŠ–ã€‚", "å›æ¥çœ‹ä¹¦ã€‚"],
            sleep: ["é†’é†’ï¼åˆ«ç¡äº†ï¼", "æ£€æµ‹åˆ°é—­çœ¼ï¼Œå¿«èµ·æ¥ï¼"],
            gaming: ["åˆ«ç©äº†ï¼Œæ ‘è¦æ¯æ­»äº†ï¼"],
            absent: ["äººå‘¢ï¼Ÿæ ‘è‹—éœ€è¦ä½ ï¼"],
            stop: "å­¦ä¹ ç»“æŸï¼Œå·²å­˜æ¡£ã€‚"
        };

        // ================= çŠ¶æ€ =================
        let faceLandmarker = null, isRunning = false;
        let lastCheck = 0, lastScreenData = null, screenHeat = 0;
        let baseScreen = null, baseBook = null;
        
        // è®¡æ—¶å™¨
        let timers = { away: null, sleep: null };
        
        // æ•°æ®
        let stats = { start: 0, score: 60, faults: [] }; // faults: {type, time, img}
        let currentPlantLevel = 0;

        // DOM
        const els = {
            webcam: document.getElementById('webcam'),
            screen: document.getElementById('screen-video'),
            ring: document.getElementById('visual-ring'),
            plant: document.getElementById('plant-icon'),
            text: document.getElementById('status-text'),
            bar: document.getElementById('activity-bar'),
            // btns
            start: document.getElementById('start-btn'),
            screenBtn: document.getElementById('screen-btn'),
            stop: document.getElementById('stop-btn'),
            history: document.getElementById('history-btn'),
            // overlays
            calibOver: document.getElementById('calib-overlay'),
            histOver: document.getElementById('history-overlay'),
            histList: document.getElementById('history-list')
        };

        // ================= åˆå§‹åŒ– =================
        async function init() {
            try {
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
                faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                    baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task", delegate: "GPU" },
                    outputFaceBlendshapes: true, runningMode: "VIDEO", numFaces: 1
                });
                els.start.innerText = "â‘¡ æ¥å…¥äººè„¸"; els.start.disabled = false;
                els.text.innerText = "ç³»ç»Ÿå°±ç»ªï¼Œè¯·æ¥å…¥ä¿¡å·æº";
            } catch(e) { console.error(e); els.text.innerText = "æ¨¡å‹åŠ è½½å¤±è´¥"; }
        }
        init();

        // ================= ä¿¡å·æ¥å…¥ =================
        els.screenBtn.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video:{cursor:"always"}, audio:false });
                els.screen.srcObject = stream;
                els.screenBtn.innerText = "âœ… å±å¹•OK"; els.screenBtn.style.background = "#2ecc71";
                document.getElementById('screen-box').classList.add('active');
            } catch(e) { alert("éœ€æ¥å…¥å±å¹•ä»¥é˜²æ‘¸é±¼"); }
        };

        els.start.onclick = async () => {
            if(!faceLandmarker) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width:640, height:480 } });
                els.webcam.srcObject = stream;
                els.webcam.onloadeddata = () => els.calibOver.style.display = 'flex';
                document.getElementById('cam-box').classList.add('active');
            } catch(e) { alert("æ‘„åƒå¤´å¤±è´¥"); }
        };

        // ================= æ ¡å‡†ä¸å¼€å§‹ =================
        const getPose = () => {
            const res = faceLandmarker.detectForVideo(els.webcam, performance.now());
            return (res.faceLandmarks.length) ? calcPose(res.faceLandmarks[0]) : null;
        };
        document.getElementById('calib-screen-btn').onclick = function() {
            if(baseScreen = getPose()) { this.classList.add('done'); this.innerText="âœ… å·²é”å®š"; checkReady(); } else alert("æ²¡çœ‹åˆ°è„¸");
        };
        document.getElementById('calib-book-btn').onclick = function() {
            if(baseBook = getPose()) { this.classList.add('done'); this.innerText="âœ… å·²é”å®š"; checkReady(); } else alert("æ²¡çœ‹åˆ°è„¸");
        };
        function checkReady() { if(baseScreen||baseBook) document.getElementById('calib-done-btn').style.opacity=1; document.getElementById('calib-done-btn').style.pointerEvents='auto'; }

        document.getElementById('calib-done-btn').onclick = () => {
            els.calibOver.style.display = 'none';
            els.start.style.display = 'none'; els.screenBtn.style.display = 'none'; els.history.style.display = 'none';
            els.stop.style.display = 'block';
            
            stats = { start: Date.now(), score: 60, faults: [] };
            isRunning = true;
            speak(SPEECH.start);
            loop();
        };

        // ================= æ ¸å¿ƒå¾ªç¯ =================
        function loop() {
            if (!isRunning) return;
            requestAnimationFrame(loop);
            const now = Date.now();
            if (now - lastCheck < CONFIG.checkInterval) return;
            lastCheck = now;

            // 1. å±å¹•æ£€æµ‹
            if (els.screen.srcObject) checkScreen();

            // 2. äººè„¸æ£€æµ‹
            if (els.webcam.currentTime > 0) {
                const res = faceLandmarker.detectForVideo(els.webcam, performance.now());
                checkFace(res);
            }

            // 3. æ›´æ–° UI (åˆ†æ•°/æˆé•¿)
            updatePlant();
        }

        // --- å±å¹•é€»è¾‘ ---
        function checkScreen() {
            const cvs = document.createElement('canvas'); cvs.width=64; cvs.height=48;
            const ctx = cvs.getContext('2d');
            ctx.drawImage(els.screen,0,0,64,48);
            const data = ctx.getImageData(0,0,64,48).data;
            
            if (lastScreenData) {
                let diff = 0;
                for(let i=0; i<data.length; i+=4) if(Math.abs(data[i]-lastScreenData[i])>20) diff++;
                if(diff > 5) screenHeat += CONFIG.screen.heatUp; else screenHeat -= CONFIG.screen.cool;
                screenHeat = Math.max(0, Math.min(CONFIG.screen.max, screenHeat));
                
                els.bar.style.width = (screenHeat/CONFIG.screen.max*100) + "%";
                if(screenHeat > CONFIG.screen.trigger) triggerFault("GAMING", "å±å¹•æ‘¸é±¼");
            }
            lastScreenData = data;
        }

        // --- äººè„¸é€»è¾‘ (å«ç–²åŠ³æ£€æµ‹) ---
        function checkFace(res) {
            // A. æ¶ˆå¤±
            if (!res.faceLandmarks.length) {
                triggerFault("ABSENT", "ç¦»å¼€ç”»é¢");
                return;
            }

            const lm = res.faceLandmarks[0];
            const bs = res.faceBlendshapes[0].categories; // Blendshapes
            
            // B. ç–²åŠ³æ£€æµ‹ (é—­çœ¼)
            // æŸ¥æ‰¾ eyeBlinkLeft å’Œ eyeBlinkRight
            const blinkL = bs.find(c => c.categoryName === 'eyeBlinkLeft').score;
            const blinkR = bs.find(c => c.categoryName === 'eyeBlinkRight').score;
            
            if (blinkL > CONFIG.threshold.eyeClose && blinkR > CONFIG.threshold.eyeClose) {
                if (!timers.sleep) timers.sleep = Date.now();
                if (Date.now() - timers.sleep > CONFIG.durations.sleep) triggerFault("SLEEP", "ç¡è§‰/é—­çœ¼");
            } else {
                timers.sleep = null;
            }

            // C. å§¿æ€æ£€æµ‹
            const p = calcPose(lm);
            let ok = false;
            if (baseScreen && isNear(p, baseScreen)) ok = true;
            if (baseBook && isNear(p, baseBook)) ok = true;

            if (!ok) {
                if (!timers.away) timers.away = Date.now();
                if (Date.now() - timers.away > CONFIG.durations.distracted) triggerFault("DISTRACTED", "è§†çº¿åç¦»");
                else updateStatus("warning", "âš ï¸ å§¿æ€è°ƒæ•´...");
            } else {
                timers.away = null;
                updateStatus("studying", "ğŸŒ± ä¸“æ³¨æˆé•¿ä¸­...");
                stats.score += CONFIG.score.perSec; // åªæœ‰å§¿åŠ¿æ­£ç¡®æ‰åŠ åˆ†
            }
        }

        // --- è¿è§„å¤„ç† ---
        let warnCool = 0;
        function triggerFault(type, label) {
            updateStatus("warning", "ğŸš¨ " + label);
            
            // æ‰£åˆ†
            const pen = {GAMING:5, SLEEP:8, ABSENT:3, DISTRACTED:2}[type];
            stats.score -= pen;
            
            // æŠ¥è­¦ (å†·å´5ç§’)
            if (Date.now() > warnCool) {
                speak(pick(SPEECH[type === 'SLEEP' ? 'sleep' : (type==='GAMING'?'gaming':(type==='ABSENT'?'absent':'warn'))]));
                capture(type); // æˆªå›¾
                warnCool = Date.now() + 5000;
            }
        }

        // --- æˆªå›¾å­˜è¯ ---
        function capture(type) {
            const cvs = document.createElement('canvas'); cvs.width=320; cvs.height=240;
            const src = (type==="GAMING") ? els.screen : els.webcam;
            const ctx = cvs.getContext('2d');
            if(type!=="GAMING") { ctx.translate(320,0); ctx.scale(-1,1); } // é•œåƒ
            ctx.drawImage(src,0,0,320,240);
            stats.faults.push({ type, time: new Date().toLocaleTimeString(), img: cvs.toDataURL('image/jpeg', 0.5) });
        }

        // --- UI æ›´æ–° ---
        function updatePlant() {
            stats.score = Math.max(0, Math.min(100, stats.score));
            
            // è®¡ç®—æˆé•¿é˜¶æ®µ (0-5)
            // åˆ†æ•°è¶Šé«˜ï¼ŒæŒç»­æ—¶é—´è¶Šé•¿ï¼Œæ ‘è¶Šå¤§
            const timeBonus = Math.min(50, (Date.now()-stats.start)/60000); // æ¯ä¸€åˆ†é’Ÿç®—ä¸€åˆ†ï¼Œæœ€å¤š50åˆ†åŸºç¡€åˆ†
            const totalLevel = stats.score + timeBonus; 
            
            let level = 0;
            if(totalLevel > 20) level = 1;
            if(totalLevel > 50) level = 2;
            if(totalLevel > 80) level = 3;
            if(totalLevel > 120) level = 4;
            if(totalLevel > 150) level = 5;
            
            if (currentPlantLevel !== level) {
                currentPlantLevel = level;
                els.plant.innerText = CONFIG.plants[level];
            }
        }

        function updateStatus(cls, txt) {
            document.body.className = cls;
            els.text.innerText = txt;
        }

        // ================= åœæ­¢ä¸å­˜æ¡£ (Persistence) =================
        els.stop.onclick = () => {
            if (prompt("å¯†ç ") === CONFIG.PASSWORD) {
                isRunning = false;
                if(els.webcam.srcObject) els.webcam.srcObject.getTracks().forEach(t=>t.stop());
                if(els.screen.srcObject) els.screen.srcObject.getTracks().forEach(t=>t.stop());
                
                saveData(); // ğŸ’¾ ä¿å­˜åˆ°æœ¬åœ°
                
                alert(`ç›‘ç£ç»“æŸï¼\næœ€ç»ˆå¾—åˆ†: ${Math.round(stats.score)}\nè¿è§„æ¬¡æ•°: ${stats.faults.length}`);
                location.reload();
            }
        };

        function saveData() {
            const record = {
                date: new Date().toLocaleString(),
                duration: Math.floor((Date.now()-stats.start)/60000),
                score: Math.round(stats.score),
                faults: stats.faults // è¿™é‡Œå­˜äº†æˆªå›¾base64ï¼Œå¦‚æœå¤ªå¤šå¯èƒ½ä¼šçˆ†localStorageï¼Œå»ºè®®åªå­˜å‰5å¼ 
            };
            
            // ç®€å•é˜²çˆ†å¤„ç†ï¼šåªå­˜æœ€è¿‘3å¼ æˆªå›¾
            if (record.faults.length > 3) record.faults = record.faults.slice(-3);

            const history = JSON.parse(localStorage.getItem('study_history') || "[]");
            history.unshift(record); // åŠ åˆ°æœ€å‰
            localStorage.setItem('study_history', JSON.stringify(history));
        }

        // ================= å†å²è®°å½•æŸ¥çœ‹ =================
        els.history.onclick = () => {
            els.histOver.style.display = 'flex';
            const history = JSON.parse(localStorage.getItem('study_history') || "[]");
            els.histList.innerHTML = history.length ? "" : "<div style='color:#666;text-align:center'>æš‚æ— è®°å½•</div>";
            
            history.forEach(rec => {
                const div = document.createElement('div');
                div.className = `history-card ${rec.score>=80?'good':'bad'}`;
                
                let imgsHtml = "";
                if(rec.faults) rec.faults.forEach(f => imgsHtml += `<img src="${f.img}" title="${f.type}">`);
                
                div.innerHTML = `
                    <div class="h-date">${rec.date} <span style="float:right">${rec.duration}åˆ†é’Ÿ</span></div>
                    <div style="margin-top:5px;">ä¸“æ³¨åˆ† <span class="h-score" style="color:${rec.score>=80?'#2ecc71':'#e74c3c'}">${rec.score}</span></div>
                    <div class="h-imgs">${imgsHtml}</div>
                `;
                els.histList.appendChild(div);
            });
        };

        document.getElementById('clear-history').onclick = () => {
            if(confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†å²æ•°æ®å—ï¼Ÿ")) {
                localStorage.removeItem('study_history');
                els.histList.innerHTML = "<div style='color:#666;text-align:center'>æš‚æ— è®°å½•</div>";
            }
        };

        // ================= å·¥å…·å‡½æ•° =================
        function calcPose(lm) {
            const nose=lm[1], left=lm[33], right=lm[263];
            const midX=(left.x+right.x)/2, eyeY=(left.y+right.y)/2;
            return { yaw: nose.x-midX, pitch: nose.y-eyeY, roll: Math.atan2(right.y-left.y, right.x-left.x)*180/Math.PI };
        }
        function isNear(c, b) {
            return Math.abs(c.yaw-b.yaw)<CONFIG.threshold.angle && Math.abs(c.pitch-b.pitch)<CONFIG.threshold.angle && Math.abs(c.roll-b.roll)<CONFIG.threshold.roll;
        }
        const synth = window.speechSynthesis;
        function speak(text) { if(synth) { synth.cancel(); const u=new SpeechSynthesisUtterance(text); u.lang="zh-CN"; u.rate=1.2; synth.speak(u); } }
        function pick(arr) { return arr[Math.floor(Math.random()*arr.length)]; }
        document.body.addEventListener('click', ()=>{if(synth)synth.speak(new SpeechSynthesisUtterance(" "))}, {once:true});

    </script>
</body>
</html>
